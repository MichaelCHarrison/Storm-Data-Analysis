---
title: "NOAA Storm Database Analysis"
author: "Michael Harrison"
date: "February 22, 2017"
output:
  html_document: default
  pdf_document: default
---

##Introduction

Storms and other severe weather events can cause both public health and economic problems for communities and municipalities. Many severe events can result in fatalities, injuries, and property damage, and preventing such outcomes to the extent possible is a key concern.

This project involves exploring the U.S. National Oceanic and Atmospheric Administration's (NOAA) storm database. This database tracks characteristics of major storms and weather events in the United States, including when and where they occur, as well as estimates of any fatalities, injuries, and property damage.

Your data analysis must address the following questions:

1. Across the United States, which types of events (as indicated in the 𝙴𝚅𝚃𝚈𝙿𝙴 variable) are most harmful with respect to population health?

2. Across the United States, which types of events have the greatest economic consequences?

### Data Processing; data cleaning, analysis

Using the read.csv, data is imported, replacing "?" with "NA" to eliminate unusuable factor level in the variable representing the exponential for property damage

All column names set to lower case for ease in coding; state columns renamed for clarity.

```{r echo=TRUE, cache=TRUE, message=FALSE, results='asis'}
library(data.table); library(dplyr); library(lubridate)
library(xtable); library(ggplot2)
options(scipen = 999)

stormdt <- fread("StormData.csv")

colnames(stormdt) <- tolower(colnames(stormdt))
colnames(stormdt)[1] <- "fips"
colnames(stormdt)[7] <- "state" 

#change date formats
stormdt$bgn_date <- mdy_hms(stormdt$bgn_date)
stormdt$end_date <- mdy_hms(stormdt$end_date)
stormdt <- stormdt[bgn_date >= "1996-01-01"] 
```



```{r}
factordmg <- function(DT){
        DT[propdmgexp == "H" | propdmgexp == "h", propdmg := propdmg * 100]
        DT[propdmgexp == "K" | propdmgexp == "k", propdmg := propdmg * 1000]
        DT[propdmgexp == "M" | propdmgexp == "m", propdmg := propdmg * 1E6]
        DT[propdmgexp == "B" | propdmgexp == "b", propdmg := propdmg * 1E9]
        
        for(i in 1:9){stormdt[propdmgexp == i, propdmg := propdmg * 10^i]}
        
        DT[cropdmgexp == "H" | cropdmgexp == "h", cropdmg := cropdmg * 100]
        DT[cropdmgexp == "K" | cropdmgexp == "k", cropdmg := cropdmg * 1000]
        DT[cropdmgexp == "M" | cropdmgexp == "m", cropdmg := cropdmg * 1E6]
        
        DT[cropdmgexp == 0, cropdmg := cropdmg * 10^0]
        DT[cropdmgexp == 2, cropdmg := cropdmg * 10^2]
}

stormdt <- factordmg(stormdt)
```

```{r}
stormdt <- stormdt %>% 
        select(fips, state, county, countyname, evtype, 
               bgn_date, bgn_time, end_date, end_time, 
               length, width, f, mag,
               fatalities, injuries, propdmg, cropdmg) %>%
        filter(fatalities > 0 | injuries > 0 | propdmg > 0 | cropdmg > 0)

#knitr::kable(head(stormdt), caption = "Working Table")
```


```{r}
stormdt$evtype <- tolower(stormdt$evtype)
stormdt$evtype <- trimws(stormdt$evtype, which = "both")
stormdt$evtype <- gsub("  ", " ", stormdt$evtype)
stormdt$evtype <- gsub("^tstm wind.*", "thunderstorm wind", stormdt$evtype)
stormdt$evtype <- gsub("^thunderstorm.*", "thunderstorm wind", stormdt$evtype)
stormdt$evtype <- gsub("^hurricane.*", "hurricane(typhoon)", stormdt$evtype)
stormdt$evtype <- gsub("^typhoon.*", "hurricane(typhoon)", stormdt$evtype)
stormdt$evtype <- gsub("^high wind.*", "high wind", stormdt$evtype)
stormdt$evtype <- gsub("^gust.*", "marine high wind", stormdt$evtype)
stormdt$evtype <- gsub("^non.*", "high wind", stormdt$evtype)
stormdt$evtype <- gsub(".*fire.*", "wildfire", stormdt$evtype)
stormdt$evtype <- gsub(".*surf.*", "high surf", stormdt$evtype)
stormdt$evtype <- gsub(".*astronomical high tide.*", "high surf", stormdt$evtype)
stormdt$evtype <- gsub(".*coastal flooding.*", "coastal flood", stormdt$evtype)
stormdt$evtype <- gsub("gradient wind", "tropcial depression", stormdt$evtype)
stormdt$evtype <- gsub("landspout", "dust devil", stormdt$evtype)
stormdt$evtype <- gsub("lake effect snow", "lake-effect snow", stormdt$evtype)
stormdt$evtype <- gsub("tropcial depression", "tropical depression", stormdt$evtype)
stormdt$evtype <- gsub("marine tstm wind", "marine thunderstorm wind",
                       stormdt$evtype)
stormdt$evtype <- gsub("glaze", "freezing fog", stormdt$evtype)
stormdt$evtype <- gsub("^tropical storm wind.*", "tropical storm", stormdt$evtype)
stormdt$evtype <- gsub(".*rain.*", "heavy rain", stormdt$evtype)
stormdt$evtype <- gsub(".*microburst.*", "thunderstorm wind", stormdt$evtype)
stormdt$evtype <- gsub(".*whirlwind.*", "thunderstorm wind", stormdt$evtype)
stormdt$evtype <- gsub(".*downburst.*", "thunderstorm wind", stormdt$evtype)
stormdt$evtype <- gsub(".*small hail.*", "hail", stormdt$evtype)
stormdt$evtype <- gsub(".*blowing dust.*", "dust storm", stormdt$evtype)
stormdt$evtype <- gsub(".*fog.*", "dense fog", stormdt$evtype)
stormdt$evtype <- gsub(".*coastalstorm.*", "tropical storm", stormdt$evtype)
stormdt$evtype <- gsub(".*coastal storm.*", "tropical storm", stormdt$evtype)
stormdt$evtype <- gsub(".*strong winds.*", "strong wind", stormdt$evtype)
stormdt$evtype <- gsub(".*heavy snow shower.*", "heavy snow", stormdt$evtype)
stormdt$evtype <- gsub(".*storm surge.*", "storm surge/tide", stormdt$evtype)
stormdt$evtype <- gsub(".*warm weather.*", "heat", stormdt$evtype)
stormdt$evtype <- gsub(".*winds.*", "high wind", stormdt$evtype)
stormdt$evtype <- gsub("^wind$", "high wind", stormdt$evtype)
stormdt$evtype <- gsub(".*excessive snow*", "blizzard", stormdt$evtype)
stormdt$evtype <- gsub("^snow$", "heavy snow", stormdt$evtype)
stormdt$evtype <- gsub(".*late season snow.*", "heavy snow", stormdt$evtype)

        

flood <- c("flood", "dam", "ice jam", "fld", "river flood", "lakeshore flood", 
           "river flooding", "high water")
for(f in flood){stormdt$evtype <- gsub(paste(".*", f, ".*", sep=""),
                                       "flood", stormdt$evtype)}

ff <- c("freeze", "hard freeze", "agricultural freeze", "frost")
for(f in ff){stormdt$evtype <- gsub(paste(".*", f, ".*", sep=""), "frost/freeze",
                                    stormdt$evtype)}

winterweather <- c("freezing", "black ice", "icy", "ice roads", "ice on road",
                   "light snow", "snow squall", "wintry", "winter", "snow and ice",
                   "rain/snow", "cold and snow", "mixed precip", "falling snow/ice",
                   "blowing snow")
for(w in winterweather){stormdt$evtype <- gsub(paste(".*", w, ".*", sep=""),
                                               "winter weather", stormdt$evtype)}

heat <- c("heat wave", "record heat", "record excessive heat",
          "hyperthermia", "unseasonably warm")
for(h in heat){stormdt$evtype <- gsub(paste(".*", h, ".*", sep = ""),
                                      "excessive heat", stormdt$evtype)}

xcold <- c("extreme cold", "unseasonable cold", "extended cold", "unseasonably cold",
          "hypothermia", "extreme windchill")
for(c in xcold){stormdt$evtype <- gsub(paste(".*", c, ".*", sep = ""),
                                      "extreme cold/wind chill", stormdt$evtype)}

cold <- c("cold", "cold temperature", "cold weather")
for(c in cold){stormdt$evtype <- gsub(paste(".*", c, ".*", sep=""), 
                                      "cold/wind chill", stormdt$evtype)}

seas <- c("heavy seas", "high seas", "rough seas", "rip currents", "wind and wave",
          "rogue wave", "high swells", "marine accident")
for(s in seas){stormdt$evtype <- gsub(paste(".*", s, ".*", sep=""), "high surf",
                                      stormdt$evtype)}

debris <- c("mudslide", "mud slide", "mudslides", "rock slide",
            "landslide","landslides", "erosion","landslump", "debris")
for(d in debris){stormdt$evtype <- gsub(paste(".*", d, ".*", sep = ""), 
                                        "debris flow", stormdt$evtype)}

stormdt <- stormdt[stormdt$evtype != "other" & stormdt$evtype != "drowning",]
stormdt$evtype <- as.factor(stormdt$evtype)
```



```{r}
matchtable <- c("astronomical low tide", "avalanche", "blizzard", "coastal flood",
                "cold/wind chill", "debris flow", "dense fog", "dense smoke",
                "drought", "dust devil", "dust storm", "excessive heat", 
                "extreme cold/wind chill", "flash flood", "flood", "frost/freeze",
                "funnel cloud", "freezing fog", "hail", "heat", "heavy rain",
                "heavy snow", "high surf", "high wind", "hurricane(typhoon)", 
                "ice storm", "lake-effect snow", "lakeshore flood", "lightning",
                "marine hail", "marine high wind", "marine strong wind", 
                "marine thunderstorm wind", "rip current", "seiche", "sleet",
                "storm surge/tide", "strong wind", "thunderstorm wind", "tornado",
                "tropical depression", "tropical storm", "tsunami",
                "volcanic ash", "waterspout", "wildfire", "winter storm",
                "winter weather")

```

```{r}
#summary(stormdt)
```


Making some plots:

```{r}
evtype_hist <- qplot(stormdt$evtype,
                     main = "Event Type Frequency accross USA",
                     xlab = "Event Type",
                     ylab = "Count")
evtype_hist + 
        theme(axis.text.x = element_text(angle = 45, hjust = 1))

```



Fatalities by event type:
```{r cache=TRUE}
event_fatalities <- stormdt %>%
        group_by(evtype) %>%
        summarise(totalfatalities = sum(fatalities)) %>%
        arrange(desc(totalfatalities))

ggplot(event_fatalities, aes(evtype, totalfatalities)) + 
        geom_bar(stat = "sum") +
        labs(title = "Fatalities by Event Type", 
             x = "Event Type", y = "Total Fatalities") +
        theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

```{r}
head(event_fatalities)
```


Injuries by event type:

```{r cache=TRUE}
event_injuries <- stormdt %>%
        group_by(evtype) %>%
        summarise(totalinjuries = sum(injuries)) %>%
        arrange(desc(totalinjuries))

ggplot(event_injuries, aes(evtype, totalinjuries)) + 
        geom_bar(stat = "sum") +
        labs(Title = "Injuries by Event Type", 
             x = "Event Type", y = "Total Injuries") +
        theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
head(event_injuries)
```


### Results